<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
    <title>MT4</title>
    <script src="/static/js/jquery.min.js"></script>
    <link rel="stylesheet" href="/static/css/bootstrap-table.min.css" />
    <script src="/static/js/bootstrap-table.min.js"></script>
    <link href="/static/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="/static/js/bootstrap-toggle.min.js"></script>
  </head>
  <body>
    <style>
      /* Clear floats after the columns */
      .row:after {
        content: "";
        display: table;
        clear: both;
      }
    </style>

    <div class="container-fluid p-5">

      <div class="row">

        <div class="col">
          <select id="accounts"></select>
          <input type="checkbox" id="copyAction" style="display: none;"  data-toggle="toggle" data-on="Copy" data-offstyle="danger" data-off="Reverse">
          <input type="checkbox" id="startAction" style="display: none;"  data-toggle="toggle" data-on="Start" data-offstyle="warning" data-off="Stop" >
        </div>
        <div class="col">
          <div role="alert" id="log">
          </div>
        </div>
      </div>

      <h2>Trade (Pending Orders)</h2>
      <hr />
      <div class="row">
        <div class="col-sm">
          <table id="tableTrade" data-toggle="table">
            <thead>
              <tr>
                <th data-field="orderID">Order ID</th>
                <th data-field="time">Time</th>
                <th data-field="type">Type</th>
                <th data-field="volume">Volume</th>
                <th data-field="symbol">Symbol</th>
                <th data-field="price">Price</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="col-sm">
          <img id="resultTrade" style="max-width: 100%;" />
        </div>
      </div>

      <h2>History (Pending Orders)</h2>
      <hr />
      <div class="row">
        <div class="col-sm">
          <table id="tableHistory" data-toggle="table">
            <thead>
              <tr>
                <th data-field="orderID">Order ID</th>
                <th data-field="time">Time</th>
                <th data-field="type">Type</th>
                <th data-field="volume">Volume</th>
                <th data-field="symbol">Symbol</th>
                <th data-field="price">Price</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="col-sm">
          <img id="resultHistory" style="max-width: 100%;" />
        </div>
      </div>
    </div>

    <script>
      var ws = new WebSocket("ws://" + location.host);
      ws.onopen = function() {
        console.log("websocket is connected ...");
      };
      ws.onmessage = function(ev) {
        const data = JSON.parse(ev.data);
        if(data.type === "log"){
          $('#log').attr('class',"alert alert-" + data.data.type).html(data.data.message);
        } else {
          const capitializedType =
            data.type.charAt(0).toUpperCase() + data.type.slice(1);
          document.querySelector("#result" + capitializedType).src =
            "/" + data.type + ".png?t=" + Date.now();
          var tableEl = $("#table" + capitializedType);
          tableEl.bootstrapTable("load", data.data);
        }
      };

      $(function() {

        fetch('/accounts').then(ret=>ret.json()).then(function(accounts){
          accounts.data.forEach(function(item){
            let selected = item === accounts.selected ? 'selected' : '';
            $('#accounts').append(`<option ${selected} value="${item}">${item}</option>`);
          });
         
          $('#accounts').change(function(){
            fetch('/accounts', {
              method: 'post',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({selected: $(this).val()})
            });
          });
        });

        fetch('/state').then(ret=>ret.json()).then(function(state){
          let copy = state.copy;
          let start = state.start;

          const update = function() {
            fetch('/state', {
              method: 'post',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({copy:copy, start:start})
            });
          };

          $('#copyAction').bootstrapToggle(copy ? 'on' : 'off');

          $('#copyAction').show().change(function() {
            copy = $(this).prop('checked');
            update();
          });

          $('#startAction').bootstrapToggle(start ? 'off' : 'on');

          $('#startAction').show().change(function() {
            start = !$(this).prop('checked');
            update();
          });
        })
    
      });

    </script>
  </body>
</html>
